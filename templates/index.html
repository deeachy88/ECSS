<!DOCTYPE html>
{% load static %}
<html lang="en">

<head>
    <meta charset="utf-8" />
        <title>DECC | Environmental Clearance Services System </title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta content="Deepak" name="author" />

        <!-- App favicon -->
        <link rel="shortcut icon" href="{% static 'assets/images/favicon.ico' %}">

        <!-- Plugin css -->
        <link rel="stylesheet" href="{% static 'assets/vendor/daterangepicker/daterangepicker.css' %}">
        <link rel="stylesheet" href="{% static 'assets/vendor/admin-resources/jquery.vectormap/jquery-jvectormap-1.2.2.css' %}">

        <!-- Theme Config Js -->
        <script src="{% static 'assets/js/hyper-config.js' %}"></script>

        <!-- App css -->
        <link href="{% static 'assets/css/app-saas.min.css' %}" rel="stylesheet" type="text/css" id="app-style" />
        <link href="{% static 'assets/css/ndi.css' %}" rel="stylesheet" type="text/css" />

        <!-- Icons css -->
        <link href="{% static 'assets/css/icons.min.css' %}" rel="stylesheet" type="text/css" />
        <!-- DataTable -->
        <link href="{% static 'assets/vendor/datatables.net-bs5/css/dataTables.bootstrap5.min.css' %}" rel="stylesheet" type="text/css" />
        <link href="{% static 'assets/vendor/datatables.net-responsive-bs5/css/responsive.bootstrap5.min.css' %}" rel="stylesheet" type="text/css" />
    <script type="text/javascript">
        // Flags to track if the respective functions have been called
        let ndiDashCalled = false;
        let ndiProponentRegCalled = false;

        // WebSocket setup
        let url = `ws://${window.location.host}/ws/socket-server/`;
        const socket = new WebSocket(url);

        socket.onmessage = function(e) {
            let data = JSON.parse(e.data);
            console.log('Data:', data);

            const id_number = data.id_number;
            const full_name = data.full_name;
            const dzongkhag = data.dzongkhag;
            const gewog = data.gewog;
            const village = data.village;

            if (id_number && !full_name && !ndiDashCalled) {
                // ID number is present and full_name is not present
                //alert('Calling makeNdiDashCall with ID Number: ' + id_number);
                makeNdiDashCall(id_number);
                ndiDashCalled = true;
            } else if (full_name && !ndiProponentRegCalled) {
                // Both ID number and full_name are present
                //alert('Calling makeNdiProponentRegCall with ID Number: ' + id_number);
                //makeNdiProponentRegCall(id_number, full_name, dzongkhag, gewog, village);
                showRegistrationForm();
                fillInputFields(id_number, full_name, dzongkhag, gewog, village);
                ndiProponentRegCalled = true;
            }
        };

        const csrftoken = getCookie('csrftoken');

        // Function to get the CSRF token from the cookie
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Function to show the registration form and hide the QR code section
        function showRegistrationForm() {
            // Hide the QR code section
            document.getElementById('ndi_div_proponent').style.display = 'none';
            // Show the registration form section
            document.getElementById('registration_div').style.display = 'block';
            // Show the modal again
            $('#registrationModalForm').modal('show');
            $('.modal-footer').show();
        }

        // Function to fill input fields with data received
        function fillInputFields(id_number, full_name, dzongkhag, gewog, village) {
            document.getElementById('cid').value = id_number;
            document.getElementById('proponent_name').value = full_name;
            document.getElementById('i_dzongkhag').value = dzongkhag;
            document.getElementById('i_gewog').value = gewog;
            document.getElementById('i_village').value = village;
        }

    </script>

</head>
<style>
.modal-custom {
      width: 80%; /* Change this to the desired width */
      border-radius: 15px; /* Adjust the radius as needed */
    }

.splitter {
    width: 100%;
    text-align: center;
    margin: 20px 0px 20px;
    border-bottom: 1px solid rgba(0, 0, 0, 0.18);
    line-height: 0.1em;
    }

.qr-loader, .qr-img {
    border: 2px solid #69bf80;
    border-radius: 15px;
    padding: 10px;
}
.navbar-nav li:hover > ul.dropdown-menu {
    display: block;
}
.dropdown-submenu {
    position:relative;
}
.dropdown-submenu > .dropdown-menu {
    top: 0;
    left: 100%;
    margin-top:-6px;
}

/* rotate caret on hover */
.dropdown-menu > li > a:hover:after {
    text-decoration: underline;
    transform: rotate(-90deg);
}
.button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    color: #fff;
    background-color: #124143;
    border-color: rgba(101, 109, 119, .24);
    white-space: nowrap;
}
.modal-body-video-btn .btn-ndi {
    background-color: #5AC994;
    color: white;
}
.modal-body-download-level {
    color: #5AC994;
}
.modal-body-question {
    text-align: center;
    padding-top: 30px;
}
.btn-pill {
    padding-right: 1.5em;
    padding-left: 1.5em;
    border-radius: 10rem;
}
    /* Loader CSS */
    #loader {
        border: 16px solid #f3f3f3; /* Light grey */
        border-top: 16px solid #3498db; /* Blue */
        border-radius: 50%;
        width: 120px;
        height: 120px;
        animation: spin 2s linear infinite;
        position: fixed;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        display: none; /* Hidden by default */
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
</style>

<body style="background-color:white;">
    <div class="container">
        <div class="row">
            <div class="col-md-11 mt-0">
                <img class="mx-auto d-block" src="{% static 'assets/images/nec_header.png' %}" style="background:center;max-width:100%">  
            </div>
        </div>
        {% include 'header.html' %}
        <hr>
        {% block content %}
            <div id="content_div">
                <div class="row">
                    <div class="col-xl-8 col-lg-7">
                        <div class="card d-block">
                            <div class="card-body">
                                {% for homepage_details in homepage_details %}
                                    <h3 class="m-0">{{homepage_details.homepage_title}}</h3>
                                {% endfor %}<br>
                                <a href="javascript: void(0);" class="text-center d-block mb-4">
                                {% for home_attachment in home_attachment %}
                                    <img src="{{home_attachment.file_path }}" class="img-fluid rounded"  alt="Product-img">
                                {% endfor %}
                                </a>
                                {% for homepage_details in homepage_details %}
                                        <h5 class="m-0">{{homepage_details.homepage_content|safe}}</h5>
                                {% endfor %}
                            </div> <!-- end card body -->
                        </div> <!-- end card -->
                    </div> <!-- end col -->
                    <div class="col-xl-4 col-lg-5">
                        {% if pub_file_attachment_count > 0 %}
                            <div class="card text-center">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-2">
                                        <h4 class="header-title">Acts and Rules</h4>
                                    </div>
                                    <hr>
                                    <div class="inbox-widget">
                                        {% for file_attachment in pub_file_attachment %}
                                            <div class="inbox-item">
                                                <a href='{{file_attachment.file_path}}' target="_blank">{{file_attachment.attachment}}</a>
                                            </div>
                                         {% endfor %}
                                    </div> <!-- end inbox-widget
                                    {% if form_file_attachment_count > 5 %}
                                        <div class="text-center mt-1">
                                            <a href="javascript:void(0);" class="text-danger"><i class="mdi mdi-spin mdi-loading me-1"></i> Load more </a>
                                        </div>
                                    {% endif %}
                                </div> <!-- end card-body-->
                            </div> <!-- end card -->
                        {% endif %}
                        {% if form_file_attachment_count > 0 %}
                            <div class="card text-center">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-2">
                                        <h4 class="header-title">Notifications</h4>
                                    </div>
                                    <hr>
                                    <div class="inbox-widget">
                                        {% for file_attachment in form_file_attachment %}
                                            <div class="inbox-item">
                                                <a href='{{file_attachment.file_path}}' target="_blank">{{file_attachment.attachment}}</a>
                                            </div>
                                        {% endfor %}
                                    </div> <!-- end inbox-widget -->
                                    {% if form_file_attachment_count > 5 %}
                                        <div class="text-center mt-1">
                                            <a href="javascript:void(0);" class="text-danger"><i class="mdi mdi-spin mdi-loading me-1"></i> Load more </a>
                                        </div>
                                    {% endif %}
                                </div> <!-- end card-body-->
                            </div> <!-- end card -->
                        {% endif %}

                        {% if down_file_attachment_count > 0 %}
                            <div class="card text-center">
                                <div class="card-body">
                                    <div class="d-flex align-items-center mb-2">
                                        <h4 class="header-title">Forms and Others</h4>
                                    </div>
                                    <hr>
                                    <div class="inbox-widget">
                                         {% for file_attachment in down_file_attachment %}
                                            <div class="inbox-item">
                                                <a href='{{file_attachment.file_path}}' target="_blank">{{file_attachment.attachment}}</a>
                                            </div>
                                         {% endfor %}
                                    </div> <!-- end inbox-widget -->
                                    {% if form_file_attachment_count > 5 %}
                                        <div class="text-center mt-1">
                                            <a href="javascript:void(0);" class="text-danger"><i class="mdi mdi-spin mdi-loading me-1"></i> Load more </a>
                                        </div>
                                    {% endif %}
                                </div> <!-- end card-body-->
                            </div> <!-- end card -->
                        {% endif %}

                    </div>


                </div>

            </div>
            <footer class="bg-dark">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-12">
                            <div>
                                <p class="text-muted mt-4 text-center mb-0">© <script>document.write(new Date().getFullYear())</script> Department of Environment and Climate Change</p>
                            </div>
                        </div>
                    </div>
                </div>
            </footer>
        {% endblock %}
    </div>
    <div class="modal fade" id="loginModalForm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content modal-custom">
                <div id="loginBox">
                    <div class="modal-header" style="text-align: center">
                        <h1 style="font-size: 1.125rem; margin-bottom: .5rem; font-weight: 800; color: black;">Environmental Clearance Services System</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-hidden="true"></button>
                    </div>
                    <form action="{% url 'login' %}" id="loginForm" method="post">
                        {% csrf_token %}
                        {% if message %}
                        <div class="alert alert-danger" id="login_error">{{ message }}</div>
                        {% endif %}
                        <div class="modal-body mx-4">
                            <div class="md-form mb-2">
                                <input type="email" id="username" name="username" placeholder="Email" class="form-control validate" autocomplete="off">
                            </div>
                            <div class="md-form pb-3">
                                <div class="input-group input-group-merge">
                                    <input type="password" name="password" id="password" class="form-control" placeholder="Password" autocomplete="off">
                                        <div class="input-group-text" data-password="false">
                                            <span class="password-eye"></span>
                                        </div>
                                </div>
                            </div>
                            <div class="text-center mb-0 d-flex justify-content-between">
                                <button class="btn btn-primary btn-sm mt-1 me-2"><i class="uil uil-message me-1"></i>Log in</button>
                                <a href="#" onclick="forgotPassword()" class="font-small blue-text forgot_button">Forgot Password?</a>
                            </div>
                        </div>
                    </form>
                    <div class="splitter">
                        <span style="background-color: rgb(255, 255, 255);">OR</span>
                    </div>
                    <div class="modal-header mx-5 pt-3 mb-1 justify-content-center" style="width: 250px;">
                        <a href="#" style="background-color: #124143; color:white; border-radius: 8px; padding: 5px 10px; display: inline-block;" id="ndiLoginId" onclick="authenticate_ndi()">
                            <img src="{% static 'assets/images/NDI_logo.png' %}" width="10%" height="10%" style="vertical-align: middle;">
                            &nbsp; &nbsp; Login with Bhutan NDI
                        </a>
                    </div>
                </div>

                <div id="ForgotBox" style="display:none;">
                    <div class="modal-header text-center">
                        <h4 class="modal-title"><strong><i class="uil uil-lock-alt"></i>&nbsp;Reset Your Password</strong></h4>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-hidden="true"></button>
                    </div>
                    <div class="modal-body mx-4">
                        <form id="forgot_password_form" method="post">
                            {% csrf_token %}
                            <div class="alert alert-danger" id="errorMsg" style="display:none"></div>
                            <div class="alert alert-info" id="successMsgReset" style="display:none"></div>
                            <div class="form-group mt-1">
                            <label>Email</label>
                            <input type="email" name="email_id" class="form-control" id="email_id" required="required" placeholder="Your Email" onchange="validateemailId(this.value)" onblur="getSecurityQuestion(this.value)">
                                <div class="alert" id="email_idErrorMsg" style="display:none"></div>
                                </div>
                            <div class="form-group mt-1">
                                <label for="security_question">Security Question</label>
                                <select class="form-control" id="security_question" name="security_question" tabindex="2" onchange="getAnswer(this.value)">
                                  <option value="">--SELECT SECURITY QUESTION--</option>
                                  {% for security in security %}
                                  <option value="{{ security.question_id }}">{{ security.question }}</option>
                                  {% endfor %}
                                </select>
                                <div class="alert" id="securityErrorMsg" style="display:none"></div>
                            </div>
                            <div class="form-group mt-1">
                                <label for="answer">Security Answer</label>
                                <input type="text" class="form-control" id="answer" name="answer" placeholder="Security Answer" tabindex="3">
                                <div class="alert" id="answerErrorMsg" style="display:none"></div>
                            </div>
                            <div class="alert" id="sucessMsg" style="display:none"></div>
                            <div class="text-center mb-3">
                                <button class="btn btn-primary btn-sm mt-2" onclick="update_password()"><i class="uil uil-envelope-add me-1"></i>Reset Password</button>
                            </div>
                            <input type="hidden" id="securityAnswer">
                                <div id="submitMsgDiv" style="display: none"></div>
                        </form>
                        <div class="modal-header mx-5 pt-3 mb-1 justify-content-center">
                            <a href="#" onclick="back()" class="font-small blue-text d-flex justify-content-center">Back To Login</a>
                        </div>
                    </div>
                </div>
                <div id="ndi_div" style="display: none; text-align: center">
                    <h1 style="font-size: 1.125rem; margin-bottom: .5rem; font-weight: 800; color: black;">Environmental Clearance Services System</h1>
                    <div class="splitter">
                    </div>
                    <h2 style="font-size: 1.0rem; margin-bottom: .5rem; font-weight: 500; color: black;">Scan with <span style="color:#5AC994 ">Bhutan NDI </span> Wallet</h2>
                    <div class="qr-img" style="margin-top: 10px">
                        <div id="deepLink" class="col-md-5 text-center" style="display: none;">
                            <button id="deepLinkBtn" class="button button1 text-white btn-bg cus-button">
                            <img src="{% static 'assets/images/NDI_logo.png' %}" alt="NDI Logo" class="ndi-logo">Open Bhutan NDI App
                            </button>
                        </div>
                        <div class="text-center" id="qrcode"><canvas width="200" height="200" style="display: none;"></canvas>
                        </div>
                        <img id="logo" src="{% static 'assets/images/NDIlogobg.png' %}" style="display: none;" />
                        <div class="row text-center">
                            <div class="counter" id="clockdiv" style="display: none;">
                                <div class="sq">
                                    <span class="seconds bord" id="timer"></span> <span class="smalltext">Secs</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row justify-content-center">
                        <div class="col-md-9 custom-vertical-align-left">
                            <br>
                            <ul class="list-unstyled" style="text-align: left;">
                                <li data-sider-select-id="783988bc-fef7-4001-aa82-d6b788c97fe7" style="margin-bottom: 10px;">1. Open Bhutan NDI on your Phone</li>
                                <li>2. Tab the Scan button located on the menu bar <img src="{% static 'assets/images/ScanButton.png' %}" alt="QR Code"> and capture code</li>
                            </ul>
                        </div>
                    </div>
                    <div class="modal-body-video-btn">
                        <a href="https://www.youtube.com/watch?v=A_k79pml9k8" target="_blank" class="btn btn-ndi btn-pill">Watch Video Guide &nbsp;<i class="mdi mdi-motion-play"></i>
                        </a>
                    </div>
                    <div class="modal-body-question">
                        <ul>
                            <li>
                                Download Now!
                                <div class="app-link">
                                    <a href="https://play.google.com/store/search?q=bhutan%20ndi&amp;c=apps&amp;hl=en_IN&amp;gl=US" target="_blank" ><img src="{% static 'assets/images/play_store.png' %}" style="height: 35px;"></a>
                                    <a href="https://apps.apple.com/in/app/bhutan-ndi/id1645493166" target="_blank" ><img src="{% static 'assets/images/app_store.png' %}" style="height: 35px;"></a>
                                    <hr>
                                    <a href="#" onclick="back()" class="font-small blue-text d-flex justify-content-center">Back To Login</a>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
      </div>
<!-- Modal -->

<div class="modal fade" id="registrationModalForm" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <!--Content-->
        <div class="modal-content modal-custom">
            <!--Header-->
            <div style="display: flex; align-items: center; justify-content: space-between; margin-right: 20px;">
                <h1 style="font-size: 1.125rem; margin-bottom: .5rem; font-weight: 800; color: black; text-align: center; margin-top: 20px; flex: 1;">Environmental Clearance Services System</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-hidden="true"></button>
            </div>
            <div style="text-align: center; margin-left: 20px;">
                <h2 style="font-size: 1.0rem; margin-bottom: .5rem; font-weight: 500; color: black;">Proponent Registration</h2>
            </div>
            <hr>
            <div class="modal-body mx-4" id="registration_div">
                <form method="post" id="client_registration_form">
                    {% csrf_token %}
                    <!--Body-->
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Proponent Type</label>
                                <select id="proponent_type" name="proponent_type" class="form-select" onchange="show_details(this.value)">
                                    <option value="">--SELECT--</option>
                                    {% for proponent_type in proponent_type %}
                                    <option value="{{ proponent_type.proponent_type_id }}">{{ proponent_type.proponent_type_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div id="proponent_typeErrorMsg" class="alert alert-danger" style="display: none;"></div>
                        </div>
                        <div class="cid_details" style="display: none;">
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="modal-header mx-5 pt-3 mb-1 justify-content-left" style="width: 200px;">
                                        <a href="#" style="background-color: #124143; color:white; border-radius: 8px; padding: 5px 10px; display: inline-block;" id="generateQRCode" onclick="registerauthenticateWithAPI()">
                                            <img src="{% static 'assets/images/NDI_logo.png' %}" width="10%" height="10%" style="vertical-align: middle;">
                                            &nbsp; &nbsp; Use Bhutan NDI
                                        </a>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">CID</label>
                                        <input type="text" oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);" class="form-control" id="cid" name="cid" maxlength="11" onchange="getCitizenDetails(this.value)">
                                        <div id="cidErrorMsg" class="alert alert-danger" role="alert" style="display: none;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-lg-6">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Proponent Name</label>
                                    <input type="text" name="proponent_name" class="form-control" id="proponent_name">
                                </div>
                                <div id="proponent_nameErrorMsg" class="alert alert-danger" role="alert" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Address</label>
                                <input type="text" name="proponent_address" class="form-control" id="proponent_address">
                            </div>
                            <div id="proponent_addressErrorMsg" class="alert alert-danger" style="display: none;"></div>
                        </div>
                        <div class="col-lg-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Contact Person</label>
                                <input type="text" name="contact_person" class="form-control" id="contact_person">
                            </div>
                            <div id="contact_personErrorMsg" class="alert alert-danger" role="alert" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Official Email</label>
                                <input type="email" name="email" class="form-control" id="email" onchange="validate_email_id(this.value)">
                            </div>
                            <div id="emailErrorMsg" class="alert alert-danger" role="alert" style="display: none;"></div>
                        </div>
                        <div class="col-lg-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Contact Number</label>
                                <input type="number" class="form-control" id="contact_number" oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);" name="contact_number" maxlength="8">
                            </div>
                            <div id="mobileErrorMsg" class="alert alert-danger" role="alert" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Dzongkhag</label>
                                <select id="dzongkhag" name="dzongkhag" class="form-select" onchange="get_gewog(this.value)">
                                    <option value="">--SELECT DZONGKHAG--</option>
                                    {% for dzongkhag in dzongkhag %}
                                    <option value="{{ dzongkhag.dzongkhag_code }}">{{ dzongkhag.dzongkhag_name }}</option>
                                    {% endfor %}
                                </select>
                                <input type="text" id="i_dzongkhag" name="i_dzongkhag" class="form-control" style="display: none;" readonly>
                            </div>
                            <div id="dzongkhagErrorMsg" class="alert alert-danger" role="alert" style="display: none;"></div>
                        </div>
                        <div class="col-lg-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Gewog</label>
                                <select id="gewog" name="gewog" class="form-select" onchange="get_village(this.value)">
                                    <option value="">--SELECT GEWOG--</option>
                                    {% for gewog in gewog %}
                                    <option value="{{ gewog.gewog_code }}">{{ gewog.gewog_name }}</option>
                                    {% endfor %}
                                </select>
                                <input type="text" id="i_gewog" name="i_gewog" class="form-control" style="display: none;" readonly>
                            </div>
                            <div id="gewogErrorMsg" class="alert alert-danger" role="alert" style="display: none;"></div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Village</label>
                                <select id="village" name="village" class="form-select">
                                    <option value="">--SELECT VILLAGE--</option>
                                    {% for village in village %}
                                    <option value="{{ village.village_code }}">{{ village.village_name }}</option>
                                    {% endfor %}
                                </select>
                                <input type="text" id="i_village" name="i_village" class="form-control" style="display: none;" readonly>
                            </div>
                            <div id="villageErrorMsg" class="alert alert-danger" role="alert" style="display: none;"></div>
                        </div>
                    </div>
                    </div>
                    <div class="modal-body" id="ndi_div_proponent" style="display: none; text-align: center">
                        <h2 style="font-size: 1.125rem; margin-bottom: .5rem; font-weight: 500;">
                            Scan QR code from <span style="color:#5AC994 ">Bhutan NDI </span> app
                        </h2>
                        <div class="qr-img" style="margin-top: 10px">
                            <div id="deepLink" class="col-md-5 text-center" style="display: none;">
                                <button id="deepLinkBtn" class="button button1 text-white btn-bg cus-button">
                                    <img src="{% static 'assets/images/NDI_logo.png' %}" alt="NDI Logo" class="ndi-logo">Open Bhutan NDI App
                                </button>
                            </div>
                            <div class="text-center" id="qrcodeproponent">
                                <canvas width="200" height="200" style="display: none;"></canvas>
                            </div>
                            <img id="logo" src="{% static 'assets/images/NDIlogobg.png' %}" style="display: none;" />
                            <div class="row text-center">
                                <div class="counter" id="clockdiv" style="display: none;">
                                    <div class="sq">
                                        <span class="seconds bord" id="timer"></span> <span class="smalltext">Secs</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row justify-content-center">
                            <div class="col-md-9 custom-vertical-align-left">
                                <br>
                                <ul class="list-unstyled" style="text-align: left;">
                                    <li data-sider-select-id="783988bc-fef7-4001-aa82-d6b788c97fe7">1. Open Bhutan NDI on your Phone</li>
                                    <li>2. Tab the Scan button located on the menu bar <img src="{% static 'assets/images/ScanButton.png' %}" alt="QR Code"> and capture code</li>
                                </ul>
                            </div>
                        </div>
                        <div class="modal-body-video-btn">
                            <a href="https://www.youtube.com/watch?v=A_k79pml9k8" target="_blank" class="btn btn-ndi btn-pill">Watch Video Guide &nbsp;<i class="mdi mdi-motion-play"></i>
                            </a>
                        </div>
                        <div class="modal-body-question">
                            <ul>
                                <li>
                                    Download Now!
                                    <div class="app-link">
                                        <a href="https://play.google.com/store/search?q=bhutan%20ndi&amp;c=apps&amp;hl=en_IN&amp;gl=US" target="_blank"><img src="{% static 'assets/images/play_store.png' %}" style="height: 35px;"></a>
                                        <a href="https://apps.apple.com/in/app/bhutan-ndi/id1645493166" target="_blank"><img src="{% static 'assets/images/app_store.png' %}" style="height: 35px;"></a>
                                    </div>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="alert alert-success" id="client_registration_message_div" style="display:none"></div>
                    <div class="alert alert-danger" id="client_registration_error_message_div" style="display:none"></div>
                    <div class="modal-footer flex-center justify-content-center">
                        <button type="button" class="btn btn-sm btn-success" onclick="register_client()" id="proponent_register_btn"><i class="uil uil-message me-1"></i>Submit</button>
                        <button type="button" class="btn btn-sm btn-danger" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>

            <!--/.Content-->
        </div>
    </div>
</div>

        <!-- Vendor js -->
        <script src="{% static 'assets/js/vendor.min.js' %}"></script>
        <!-- Daterangepicker js -->
        <script src="{% static 'assets/vendor/daterangepicker/moment.min.js' %}"></script>
        <script src="{% static 'assets/vendor/daterangepicker/daterangepicker.js' %}"></script>
        <!-- App js -->
        <script src="{% static 'assets/js/app.min.js' %}"></script>
        <!-- NDI -->
        <script src="{% static 'assets/js/ndi.js' %}"></script>
        <script src="{% static 'assets/js/jquery-qrcode.min.js' %}"></script>
        <script src="https://cdn.jsdelivr.net/npm/nats@2.1.7/dist/nats-base-client.umd.min.js"></script>
    <script>
        function forgotPassword()
        {
			$('#loginBox').hide();
			$('#ForgotBox').show();
	 	}

         function back()
         {
			$('#loginBox').show();
			$('#ForgotBox').hide();
			$('#ndi_div').hide();
	 	}

        function get_gewog(dzongkhag_id)
        {
            $.ajax({
                type : "GET",
                url : "{% url 'load_gewog' %}",
                data :{'dzongkhag_id':dzongkhag_id},
                success : function(data)
                {
                    $('#gewog').html(data);
                }
            });
        }

        function get_village(gewog_id)
        {
            $.ajax({
                type : "GET",
                url : "{% url 'load_village' %}",
                data :{'gewog_id':gewog_id},
                success : function(data)
                {
                    $('#village').html(data);
                }
            });
        }

        function validate_email_id(email)
        {
            var pattern=/[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,3}$/;
            var no=email.match(pattern);

            if(no==null)
            {
                $('#emailErrorMsg').html("The email is invalid");
                $('#email').val("");
                $('#emailErrorMsg').show();
                $('#emailErrorMsg').delay(2000).fadeOut('slow');
            }
            else
            {
                $('#emailErrorMsg').hide();
            }
        }

        function register_client()
        {
            let proponent_type = $('#proponent_type').val();
            if(proponent_type ='4')
            {
                let cid = $('#cid').val();
            }
            let proponent_name = $('#proponent_name').val();
            let address = $('#proponent_address').val();
            let contact_person = $('#contact_person').val();
            let email = $('#email').val();
            let contact_number = $('#contact_number').val();
            let contact_number_count = $('#contact_number').val().length;
            let dzongkhag = $('#dzongkhag').val();
            let gewog = $('#gewog').val();
            let village = $('#village').val();

            if(proponent_type == "")
            {
                $('#proponent_typeErrorMsg').html("Select Proponent Type.");
                $('#proponent_typeErrorMsg').show();
                $('#proponent_typeErrorMsg').delay(2000).fadeOut('slow');
                $("#proponent_type").focus();
            }
            else if(proponent_type !='4' && cid == "")
            {
                $('#cidErrorMsg').html("Enter CID.");
                $('#cidErrorMsg').show();
                $('#cidErrorMsg').delay(2000).fadeOut('slow');
                $("#cid").focus();
            }
            else if(proponent_name == "")
            {
                $('#proponent_nameErrorMsg').html("Enter Proponent Name.");
                $('#proponent_nameErrorMsg').show();
                $('#proponent_nameErrorMsg').delay(2000).fadeOut('slow');
                $("#proponent_name").focus();
            }
            else if(address == "")
            {
                $('#proponent_addressErrorMsg').html("Enter Address.");
                $('#proponent_addressErrorMsg').show();
                $('#proponent_addressErrorMsg').delay(2000).fadeOut('slow');
            }
            else if(contact_person == "")
            {
                $('#contact_personErrorMsg').html("Enter Contact Person.");
                $('#contact_personErrorMsg').show();
                $('#contact_personErrorMsg').delay(2000).fadeOut('slow');
            }
            else if(email == "")
            {
                $('#emailErrorMsg').html("Enter Official Email.");
                $('#emailErrorMsg').show();
                $('#emailErrorMsg').delay(2000).fadeOut('slow');
            }
            else if(contact_number == "")
            {
                $('#contact_numberErrorMsg').html("Enter Contact Number.");
                $('#contact_numberErrorMsg').show();
                $('#contact_numberErrorMsg').delay(2000).fadeOut('slow');
            }
            else if(contact_number_count < 8)
            {
                $('#contact_numberErrorMsg').html("Cannot Be Less Than Eight Digits.");
                $('#contact_numberErrorMsg').show();
                $('#contact_numberErrorMsg').delay(2000).fadeOut('slow');
            }
            else if(proponent_type !='4' && dzongkhag == "")
            {
                $('#dzongkhagErrorMsg').html("Select Dzongkhag.");
                $('#dzongkhagErrorMsg').show();
                $('#dzongkhagErrorMsg').delay(2000).fadeOut('slow');
            }
            else if(proponent_type !='4' && gewog == "")
            {
                $('#gewogErrorMsg').html("Select Gewog.");
                $('#gewogErrorMsg').show();
                $('#gewogErrorMsg').delay(2000).fadeOut('slow');
            }
            else if(proponent_type !='4' && village == "")
            {
                $('#villageErrorMsg').html("Select Village.");
                $('#villageErrorMsg').show();
                $('#villageErrorMsg').delay(2000).fadeOut('slow');
            }
            else
            {
                $.ajax({
                    type : "POST",
                    url : "{% url 'check_email_id' %}",
                    data : $('#client_registration_form').serialize(),
                    success : function(data)
                    {
                        if(data.count == "1")
                        {
                            $('#email').val("");
                            $('#emailErrorMsg').html("Email Already Exists.Try With Another Email");
                            $('#emailErrorMsg').show();
                            $('#emailErrorMsg').delay(2000).fadeOut('slow');
                        }
                        else
                        {
                            $.ajax({
                                type : "POST",
                                url : "{% url 'client_registration' %}",
                                data : $('#client_registration_form').serialize(),
                                success : function(data)
                                {
                                    if(data.message == "registration successful")
                                    {
                                        $('#client_registration_message_div').show();
                                        $('#client_registration_message_div').html("Client Registered Successfully");
                                        setTimeout(function() {
                                            $('#client_registration_message_div').delay(2000).fadeOut('slow');
                                        }, 3000);
                                        setTimeout(function() {
                                            location.reload();
                                        }, 3000);
                                    }
                                    else
                                    {
                                        $('#client_registration_error_message_div').show();
                                        $('#client_registration_error_message_div').html("Client Registration Failed");
                                        setTimeout(function() {
                                            $('#client_registration_error_message_div').delay(2000).fadeOut('slow');
                                        }, 3000);
                                        setTimeout(function() {
                                            location.reload();
                                        }, 3000);
                                    }
                                }
                            });
                        }
                    }
                });
            }
        }

    function update_password()
    {

        var uid = $('#email_id').val();
        var answer = $('#answer').val();
        var security = $('#security').val();
        var answerForm =  $('#securityAnswer').val();

        if(uid == "")
        {
            $('#emailErrorMsg').html("Email Is Required");
            $('#emailErrorMsg').show();
            $('#email').focus();
            $('#emailErrorMsg').delay(2000).fadeOut('slow');
        }
        else if(security == "")
        {
            $('#securityErrorMsg').html("Select Security Question");
            $('#securityErrorMsg').show();
            $('#security').focus();
            $('#securityErrorMsg').delay(2000).fadeOut('slow');
        }
        else if(answer == "")
        {
            $('#answerErrorMsg').html("Enter Your Security Questions Answer");
            $('#answerErrorMsg').show();
            $('#answer').focus();
            $('#answerErrorMsg').delay(2000).fadeOut('slow');
        }
        else
        {
            var enteredAnswer = $('#answer').val();
            if(answerForm.toLowerCase() == enteredAnswer.toLowerCase())
            {
                $('#answerErrorMsg').html("Please Wait..");
                $('#answerErrorMsg').show();
                $('#answerErrorMsg').delay(3000).fadeOut('slow');
                $('#submit_button').hide();
                $.ajax({
                    type: 'POST',
                    url : "{% url 'update_password' %}",
                    data : $('#forgot_password_form').serialize(),
                    success: function(data)
                    {
                        $('#sucessMsg').show();
                        $('#sucessMsg').delay(2000).fadeOut('slow');
                        $('#submit_button').show();
                        setTimeout('location.reload()',3000);
                    }
                });
            }
            else
            {
                $('#answerErrorMsg').html("The answer you entered does not match your previous answer, please verify and try again else contact administrator");
                $('#answerErrorMsg').show();
                $('#answerErrorMsg').delay(2000).fadeOut('slow');
            }
        }
    }

    function getSecurityQuestion(uid)
     {
        if(uid == "")
        {
            $('#email_idErrorMsg').html("Email Is Required.");
            $('#email_idErrorMsg').show();
            $('#email_idErrorMsg').delay(2000).fadeOut('slow');
        }
        else
        {
            $.ajax({
                type : "GET",
                url : "{% url 'load_security_question' %}",
                data :{'email':uid},
                success : function(data)
                {
                    $('#security_question').html(data);
                }
            });
        }
     }

    function getAnswer(questionId)
    {
        var uid = $('#email_id').val();
        $.ajax({
            async: false,
            type: 'GET',
            url : "{% url 'get_security_answer' %}",
            data :{'questionId':questionId, 'email_id':uid,  csrfmiddlewaretoken: '{{ csrf_token }}'},
            success: function(data)
            {
                $('#securityAnswer').val(data.answer);
            }
        });
    }

    function validateemailId(emailId)
    {
        var pattern=/[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,3}$/;
        var no=emailId.match(pattern);

        if(no==null)
        {
            $('#email_idErrorMsg').html("<span class='alert alert-danger'>The email Id is Not valid");
            $('#email_id').val("");
            $('#email_idErrorMsg').show();
            $('#email_idErrorMsg').delay(2000).fadeOut('slow');
        }else{
         $('#email_idErrorMsg').hide();
        }

    }

    function loadSubMenuPage(menu_id)
    {
        $.ajax
		({
			type : "GET",
			url : "{% url 'get_content_details' %}",
			data : {'menu_id':menu_id, 'identifier':'SM'},
			dataType : "html",
			success : function(responseText)
			{
			    $('#content_div').show();
				$("#content_div").html(responseText);
			}
		});
    }

    function loadMenuPage(menu_id)
    {
        $.ajax
		({
			type : "GET",
			url : "{% url 'get_content_details' %}",
			data : {'menu_id':menu_id, 'identifier':'M'},
			dataType : "html",
			success : function(responseText)
			{
				$("#content_div").html(responseText);
				$('#content_div').show();
			}
		});
    }

    function show_details(value)
    {
        if (value=="4")
        {
            $('#dzongkhag').hide();
            $('#gewog').hide();
            $('#village').hide();
            $('.cid_details').show();
            $('#proponent_name').attr("readonly", "readonly");
            $('#i_dzongkhag').show();
            $('#i_gewog').show();
            $('#i_village').show();
        // Clear the values of the fields
            $('#dzongkhag').val('');
            $('#gewog').val('');
            $('#village').val('');
            $('#cid').val('');
            $('#proponent_name').val('');
            $('#i_dzongkhag').val('');
            $('#i_gewog').val('');
            $('#i_village').val('');
        }
        else
        {
            $('#dzongkhag').show();
            $('#gewog').show();
            $('#village').show();
            $('#proponent_name').removeAttr("readonly");
            $('.cid_details').hide();
            $('#i_dzongkhag').hide();
            $('#i_gewog').hide();
            $('#i_village').hide();
        // Clear the values of the fields

            $('#dzongkhag').val('');
            $('#gewog').val('');
            $('#village').val('');
            $('#proponent_name').val('');
            $('#i_dzongkhag').val('');
            $('#i_gewog').val('');
            $('#i_village').val('');
        }
    }
    function getCitizenDetails(cid)
    {
        $.ajax({
            type : "GET",
            url : "{% url 'check_cid_exists' %}",
            data :{'cid':cid},
            success : function(data)
            {
                if(data.count > 0)
                {
                    $('#cid').val("");
                    $('#proponent_name').val("");
                    $('#i_dzongkhag').val("");
                    $('#i_gewog').val("");
                    $('#i_village').val("");
                    $('#cidErrorMsg').html("CID Already Exists.Try With Another one");
                    $('#cidErrorMsg').show();
                    $('#cidErrorMsg').delay(2000).fadeOut('slow');
                }
                else
                {
                    const myObj =data.response;
                    if(myObj.citizendatas.citizendata == undefined)
                    {
                        $('#cid').val("");
                        $('#cidErrorMsg').html("Invalid CID.Try With Another one");
                        $('#cidErrorMsg').show();
                        $('#cidErrorMsg').delay(2000).fadeOut('slow');
                    }
                    else
                    {
                        var CitizenName = myObj.citizendatas.citizendata[0].Name
                        var dzongkhagName = myObj.citizendatas.citizendata[0].Dzongkhag_Name
                        var villageName = myObj.citizendatas.citizendata[0].Gewog_Name
                        var gewogName = myObj.citizendatas.citizendata[0].Village_Name
                        $('#proponent_name').val(CitizenName);
                        $('#i_dzongkhag').val(dzongkhagName);
                        $('#i_gewog').val(gewogName);
                        $('#i_village').val(villageName);
                    }
                }
            }
        });
    }

function authenticate_ndi() {
    $.ajax({
        type: "GET",
        url: "/proof_request/", // This assumes the proof_request URL is mapped in your Django urls.py file
        success: function(data) {
            var verifierData = data.data;
            var proofRequestURL = verifierData.proofRequestURL;
            var proofRequestThreadId = verifierData.proofRequestThreadId;
            var deepLinkURL = verifierData.deepLinkURL;

            $('.modal-footer').hide();
            if (window.innerWidth < 992) {
                // Show button on small and medium screens
                $('#loginBox').hide();
                $("#ndi_div").show();
                $("#deepLink").show();
                $('#deepLinkBtn').val(deepLinkURL);
                nats_call(proofRequestThreadId);
            } else {
                // Show QR code on larger screens
                $('#loginBox').hide();
                $("#ndi_div").show();
                $('#qrcode').qrcode({
                    render: 'canvas',
                    minVersion: 1,
                    maxVersion: 40,
                    ecLevel: 'L',
                    left: 0,
                    top: 0,
                    size: 200,
                    fill: '#000',
                    background: '#fff',
                    text: proofRequestURL,
                    radius: 0,
                    quiet: 0,
                    mode: 4,
                    mSize: 0.15,
                    mPosX: 0.5,
                    mPosY: 0.5,
                    label: '',
                    fontcolor: '#000',
                    fontname: 'sans',
                    image: document.getElementById('logo'),
                });
                $('#qrcode').show(); // Show the QR code
                $("#ndi_button").hide();
                nats_call(proofRequestThreadId);
            }
        }
    });
}

function registerauthenticateWithAPI() {
    $.ajax({
        type: "GET",
        url: "/proof_request_proponent/", // This assumes the proof_request URL is mapped in your Django urls.py file
        success: function(data) {
            var verifierData = data.data;
            var proofRequestURL = verifierData.proofRequestURL;
            var proofRequestThreadId = verifierData.proofRequestThreadId;
            var deepLinkURL = verifierData.deepLinkURL;

            $('.modal-footer').hide();
            if (window.innerWidth < 992) {
                // Show button on small and medium screens
                $('#registration_div').hide();
                $("#ndi_div_proponent").show();
                $("#deepLink").show();
                $('#deepLinkBtn').val(deepLinkURL);
                nats_proponent_call(proofRequestThreadId);
            } else {
                // Show QR code on larger screens
                $('#registration_div').hide();
                $("#ndi_div_proponent").show();
                $('#qrcodeproponent').qrcode({
                    render: 'canvas',
                    minVersion: 1,
                    maxVersion: 40,
                    ecLevel: 'L',
                    left: 0,
                    top: 0,
                    size: 200,
                    fill: '#000',
                    background: '#fff',
                    text: proofRequestURL,
                    radius: 0,
                    quiet: 0,
                    mode: 4,
                    mSize: 0.15,
                    mPosX: 0.5,
                    mPosY: 0.5,
                    label: '',
                    fontcolor: '#000',
                    fontname: 'sans',
                    image: document.getElementById('logo'),
                });
                $('#qrcode').show(); // Show the QR code
                $("#ndi_button").hide();
                nats_proponent_call(proofRequestThreadId);
            }
        }
    });
}



    </script>
</body>
</html>
